@model IEnumerable<FinanceApp.Models.Expense>

@{
    ViewData["Title"] = "Dashboard";
    var totalExpenses = Model.Sum(e => e.Amount);
    var expenseCount = Model.Count();
    var avgExpense = expenseCount > 0 ? totalExpenses / expenseCount : 0;
    var thisMonthExpenses = Model.Where(e => e.Date.Month == DateTime.Now.Month && e.Date.Year == DateTime.Now.Year).Sum(e => e.Amount);
}

<div class="page-container fade-in">
    <!-- Success Message -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> <strong>Success!</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="bi bi-speedometer2"></i> Finance Dashboard</h1>
        <div>
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Expense
            </a>
            <a asp-action="Manage" class="btn btn-success">
                <i class="bi bi-gear"></i> Manage
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Total Expenses</div>
                <div class="stat-value">$@totalExpenses.ToString("N2")</div>
                <small><i class="bi bi-calendar-month"></i> All Time</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card success">
                <div class="stat-label">This Month</div>
                <div class="stat-value">$@thisMonthExpenses.ToString("N2")</div>
                <small><i class="bi bi-calendar-check"></i> @DateTime.Now.ToString("MMMM yyyy")</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card warning">
                <div class="stat-label">Average Expense</div>
                <div class="stat-value">$@avgExpense.ToString("N2")</div>
                <small><i class="bi bi-graph-up"></i> Per Transaction</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card danger">
                <div class="stat-label">Total Count</div>
                <div class="stat-value">@expenseCount</div>
                <small><i class="bi bi-receipt"></i> Transactions</small>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="🔍 Search expenses...">
            </div>
            <div class="col-md-3">
                <select id="categoryFilter" class="form-select">
                    <option value="">All Categories</option>
                    @foreach(var category in Model.Select(e => e.Category).Distinct().OrderBy(c => c))
                    {
                        <option value="@category">@category</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select id="sortBy" class="form-select">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="amount-desc">Highest Amount</option>
                    <option value="amount-asc">Lowest Amount</option>
                </select>
            </div>
            <div class="col-md-2">
                <button id="resetFilters" class="btn btn-warning w-100">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Expenses Table -->
    <div class="row">
        <div class="col-lg-8">
            <h3 class="mb-3"><i class="bi bi-list-ul"></i> Recent Expenses</h3>
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table" id="expensesTable">
                        <thead>
                            <tr>
                                <th><i class="bi bi-card-text"></i> Description</th>
                                <th><i class="bi bi-currency-dollar"></i> Amount</th>
                                <th><i class="bi bi-tag"></i> Category</th>
                                <th><i class="bi bi-calendar"></i> Date</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            @foreach(var item in Model.OrderByDescending(e => e.Date))
                            {
                                <tr data-description="@item.Description.ToLower()" 
                                    data-category="@item.Category" 
                                    data-amount="@item.Amount" 
                                    data-date="@item.Date.ToString("yyyy-MM-dd")">
                                    <td><strong>@item.Description</strong></td>
                                    <td><span class="badge bg-primary">$@item.Amount.ToString("N2")</span></td>
                                    <td><span class="category-badge" style="background-color: @GetCategoryColor(item.Category); color: white;">@item.Category</span></td>
                                    <td>@item.Date.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No expenses yet. <a asp-action="Create" class="alert-link">Add your first expense!</a>
                </div>
            }
        </div>

        <!-- Chart Section -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h3 class="mb-3"><i class="bi bi-pie-chart"></i> Expenses by Category</h3>
                <canvas id="myChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Chart.js Configuration
        const ctx = document.getElementById('myChart');
        let chartInstance = null;

        fetch('/Expenses/GetChart')
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const colors = [
                    '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', 
                    '#10b981', '#3b82f6', '#ef4444', '#14b8a6'
                ];

                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.category),
                        datasets: [{
                            data: data.map(d => d.total),
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += '$' + context.parsed.toFixed(2);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });

        // Search and Filter Functionality
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const sortBy = document.getElementById('sortBy');
        const resetBtn = document.getElementById('resetFilters');
        const tableBody = document.getElementById('expensesTableBody');

        function filterAndSortTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const sortOption = sortBy.value;

            let rows = Array.from(tableBody.querySelectorAll('tr'));

            // Filter
            rows.forEach(row => {
                const description = row.getAttribute('data-description');
                const category = row.getAttribute('data-category');
                
                const matchesSearch = description.includes(searchTerm);
                const matchesCategory = !selectedCategory || category === selectedCategory;

                row.style.display = (matchesSearch && matchesCategory) ? '' : 'none';
            });

            // Sort visible rows
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            
            visibleRows.sort((a, b) => {
                const dateA = new Date(a.getAttribute('data-date'));
                const dateB = new Date(b.getAttribute('data-date'));
                const amountA = parseFloat(a.getAttribute('data-amount'));
                const amountB = parseFloat(b.getAttribute('data-amount'));

                switch(sortOption) {
                    case 'date-asc':
                        return dateA - dateB;
                    case 'date-desc':
                        return dateB - dateA;
                    case 'amount-asc':
                        return amountA - amountB;
                    case 'amount-desc':
                        return amountB - amountA;
                    default:
                        return dateB - dateA;
                }
            });

            // Reorder rows
            visibleRows.forEach(row => tableBody.appendChild(row));
        }

        searchInput.addEventListener('input', filterAndSortTable);
        categoryFilter.addEventListener('change', filterAndSortTable);
        sortBy.addEventListener('change', filterAndSortTable);
        
        resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            categoryFilter.value = '';
            sortBy.value = 'date-desc';
            filterAndSortTable();
        });
    </script>
}

@functions {
    string GetCategoryColor(string category)
    {
        var colors = new Dictionary<string, string>
        {
            { "Food", "#f59e0b" },
            { "Transport", "#3b82f6" },
            { "Entertainment", "#ec4899" },
            { "Shopping", "#8b5cf6" },
            { "Health", "#10b981" },
            { "Utilities", "#6366f1" },
            { "Education", "#14b8a6" },
            { "Other", "#64748b" }
        };

        if (colors.ContainsKey(category))
            return colors[category];
        
        // Generate consistent color for unknown categories
        var hash = category.GetHashCode();
        var r = (hash & 0xFF0000) >> 16;
        var g = (hash & 0x00FF00) >> 8;
        var b = hash & 0x0000FF;
        return $"#{r:X2}{g:X2}{b:X2}";
    }
}
